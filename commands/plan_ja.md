---
description: 要件を再述し、リスクを評価し、ステップバイステップの実装計画を作成します。コードに触れる前にユーザーの確認を待ちます。
---

# Plan コマンド

このコマンドは、**planner** エージェントを起動して、コードを書く前に包括的な実装計画を作成します。

## このコマンドの役割

1. **要件の再述** - 構築する必要があるものを明確化
2. **リスクの特定** - 潜在的な問題とブロッカーを明らかにする
3. **段階的計画の作成** - 実装をフェーズに分割
4. **確認を待つ** - 進める前にユーザーの承認を得る必須事項

## 使用する場合

以下の場合に `/plan` を使用します：
- 新しい機能を開始する場合
- 大規模なアーキテクチャ変更を行う場合
- 複雑なリファクタリングを行う場合
- 複数のファイル/コンポーネントが影響を受ける場合
- 要件が不明確または曖昧な場合

## 動作方法

planner エージェントは以下を行います：

1. **リクエストを分析** し、要件を明確な用語で再述
2. **フェーズに分割** して、具体的かつ実行可能なステップを提示
3. **コンポーネント間の依存関係を特定**
4. **リスクを評価** して、潜在的なブロッカーを抽出
5. **複雑さを見積もる** （高/中/低）
6. **計画を提示** して、明示的な確認を待つ

## 使用例

```
ユーザー: /plan マーケットが解決された時にリアルタイム通知を追加する必要があります

エージェント（planner）:
# 実装計画：リアルタイムマーケット解決通知

## 要件の再述
- ウォッチ中のマーケットが解決された時、ユーザーに通知を送信
- 複数の通知チャネルをサポート（アプリ内、メール、ウェブフック）
- 通知が確実に配信されることを保証
- マーケットの結果とユーザーのポジション結果を含める

## 実装フェーズ

### フェーズ1：データベーススキーマ
- 通知テーブルを追加（カラム: id、user_id、market_id、type、status、created_at）
- ユーザー通知設定テーブルをチャネル設定用に追加
- パフォーマンス向上のためにuser_idとmarket_idにインデックスを作成

### フェーズ2：通知サービス
- lib/notifications.tsに通知サービスを作成
- BullMQ/Redisを使用して通知キューを実装
- 配信失敗時のリトライロジックを追加
- 通知テンプレートを作成

### フェーズ3：統合ポイント
- マーケット解決ロジックにフック（ステータスが「resolved」に変更される時）
- マーケット内のポジションを持つすべてのユーザーをクエリ
- 各ユーザーの通知をキューに追加

### フェーズ4：フロントエンドコンポーネント
- ヘッダーにNotificationBellコンポーネントを作成
- NotificationListモーダルを追加
- Supabaseサブスクリプションでリアルタイム更新を実装
- 通知設定ページを追加

## 依存関係
- Redis（キュー用）
- メールサービス（SendGrid/Resend）
- Supabaseリアルタイムサブスクリプション

## リスク
- 高：メール配信性（SPF/DKIM必須）
- 中：1000以上のユーザーがいるマーケットでのパフォーマンス
- 中：マーケットが頻繁に解決した場合の通知スパム
- 低：リアルタイムサブスクリプション管理

## 見積もり複雑度：中
- バックエンド：4～6時間
- フロントエンド：3～4時間
- テスト：2～3時間
- 合計：9～13時間

**確認待機中**：この計画で進めますか？（yes/no/modify）
```

## 重要な注記

**重要**：planner エージェントは、明示的な確認を得るまで、**どのようなコードも書きません**。

変更したい場合は、以下のように回答してください：
- "modify: [変更内容]"
- "different approach: [代替案]"
- "skip phase 2 and do phase 3 first"

## 他のコマンドとの統合

計画の後：
- `/tdd` を使用してテスト駆動開発で実装
- ビルドエラーが発生した場合は `/build-and-fix` を使用
- 実装が完了したら `/code-review` で確認

## 関連エージェント

このコマンドは `planner` エージェントを起動します。場所：
`~/.claude/agents/planner.md`
